<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>VOCALIA DE EMERGENCIAS REGIÓN DE MURCIA V3</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s;
        }
        
        body.emergency-mode {
            background: linear-gradient(135deg, #8b0000 0%, #8b0000 100%);
        }
        
        .app-container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            overflow: hidden;
            display: flex;
            height: 95vh;
        }
        
        .sidebar {
            width: 500px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            padding: 25px;
            overflow-y: auto;
            border-right: 3px solid #e74c3c;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar.collapsed {
            width: 0;
            padding: 0;
            border-right: none;
            overflow: hidden;
        }
        
        .sidebar-toggle {
            position: absolute;
            top: 50%;
            left: 500px;
            transform: translateY(-50%);
            background: #e74c3c;
            color: white;
            border: none;
            width: 30px;
            height: 60px;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 2px 0 5px rgba(0,0,0,0.3);
        }
        
        .sidebar-toggle:hover {
            background: #c0392b;
            width: 35px;
        }
        
        .sidebar-toggle.collapsed {
            left: 0;
            border-radius: 0 8px 8px 0;
        }
        
        .sidebar-toggle i {
            font-size: 16px;
            transition: transform 0.3s;
        }
        
        .sidebar-toggle.collapsed i {
            transform: rotate(180deg);
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0f3460;
            transition: all 0.3s;
        }
        
        .main-content.expanded {
            margin-left: 0;
        }
        
        .header {
            padding: 15px 25px;
            background: #0c2461;
            color: white;
            border-bottom: 3px solid #e74c3c;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
        }
        
        .header h1 {
            font-size: 26px;
            margin-bottom: 5px;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .header h2 {
            font-size: 16px;
            color: #e74c3c;
            font-weight: 600;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        
        .header p {
            color: #bdc3c7;
            font-size: 14px;
            font-style: italic;
        }
        
        .emergency-banner {
            background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            width: 90%;
            margin: 10px auto;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        /* MODIFICADO: Panel de filtros unificado a la derecha */
        .filters-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            width: 280px;
            backdrop-filter: blur(5px);
            border: 2px solid #3498db;
            transition: all 0.3s;
        }
        
        .filters-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            color: #3498db;
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .filters-header i {
            transition: transform 0.3s;
        }
        
        .filters-header.collapsed i {
            transform: rotate(-180deg);
        }
        
        .filters-content {
            max-height: 500px;
            opacity: 1;
            overflow: hidden;
            transition: max-height 0.3s, opacity 0.3s, margin 0.3s;
            margin-top: 15px;
        }
        
        .filters-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }
        
        .filter-group {
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(52, 152, 219, 0.3);
            padding-bottom: 10px;
        }
        
        .filter-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .filter-title {
            color: #3498db;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-option {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ecf0f1;
            font-size: 13px;
        }
        
        .filter-select {
            width: 100%;
            padding: 6px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid #3498db;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .filter-select option {
            background: #1a1a2e;
            color: white;
        }
        
        /* Toggle switches */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #34495e;
            transition: .4s;
            border-radius: 20px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #e74c3c;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        .filter-badge {
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 5px;
        }
        
        /* MODIFICADO: Panel de operador en sidebar (abajo) */
        .operator-section {
            margin-top: auto;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border: 2px solid #e67e22;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .operator-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #e67e22;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
        }
        
        .operator-header i:last-child {
            transition: transform 0.3s;
        }
        
        .operator-header.collapsed i:last-child {
            transform: rotate(-180deg);
        }
        
        .operator-content {
            max-height: 400px;
            opacity: 1;
            overflow: hidden;
            transition: max-height 0.3s, opacity 0.3s;
        }
        
        .operator-content.collapsed {
            max-height: 0;
            opacity: 0;
        }
        
        .operator-fields {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .operator-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .operator-field label {
            color: #ecf0f1;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .operator-field input {
            background: rgba(0,0,0,0.3);
            border: 1px solid #e67e22;
            border-radius: 4px;
            padding: 8px;
            color: white;
            font-size: 13px;
        }
        
        .operator-field input:focus {
            outline: none;
            border-color: #f39c12;
            box-shadow: 0 0 0 2px rgba(230, 126, 34, 0.2);
        }
        
        .operator-location-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 5px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            border-left: 3px solid #e67e22;
        }
        
        .operator-coords-group {
            display: flex;
            gap: 10px;
        }
        
        .operator-coords-group input {
            width: 50%;
        }
        
        .operator-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .btn-operator {
            flex: 1;
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.3s;
            min-width: 80px;
        }
        
        .btn-operator:hover {
            background: linear-gradient(135deg, #d35400 0%, #e67e22 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(230, 126, 34, 0.4);
        }
        
        .operator-display {
            background: rgba(230, 126, 34, 0.1);
            border: 1px solid #e67e22;
            border-radius: 4px;
            padding: 8px;
            margin-top: 10px;
            font-size: 12px;
            color: #ecf0f1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .operator-display span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .operator-display i {
            color: #e67e22;
            width: 16px;
        }
        
        .coord-display {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px 18px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            z-index: 1000;
            max-width: 350px;
            backdrop-filter: blur(5px);
            border: 1px solid #3498db;
        }
        
        /* Estadísticas */
        .stats-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            z-index: 1000;
            min-width: 220px;
            backdrop-filter: blur(5px);
            border: 2px solid #e74c3c;
        }
        
        .stats-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            color: #e74c3c;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stats-header i {
            transition: transform 0.3s;
        }
        
        .stats-header.collapsed i {
            transform: rotate(-180deg);
        }
        
        .stats-content {
            max-height: 300px;
            opacity: 1;
            overflow: hidden;
            transition: max-height 0.3s, opacity 0.3s, margin 0.3s;
            margin-top: 10px;
        }
        
        .stats-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            font-size: 12px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-label {
            color: #bdc3c7;
        }
        
        .stat-value {
            font-weight: 600;
            color: #ecf0f1;
        }
        
        /* Estilos del formulario (sin cambios) */
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .form-title {
            font-size: 18px;
            font-weight: 600;
            color: #e74c3c;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #ecf0f1;
            font-size: 14px;
        }
        
        .required::after {
            content: " *";
            color: #e74c3c;
        }
        
        .optional {
            color: #95a5a6;
            font-size: 11px;
            font-weight: normal;
            margin-left: 5px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #34495e;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #e74c3c;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        
        .locator-input {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .coordinate-input {
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .input-selector {
            display: flex;
            margin-bottom: 10px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #34495e;
        }
        
        .input-option {
            flex: 1;
            text-align: center;
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            border-right: 1px solid #34495e;
        }
        
        .input-option:last-child {
            border-right: none;
        }
        
        .input-option:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .input-option.active {
            background: #3498db;
            color: white;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .checkbox-label {
            color: #ecf0f1;
            font-weight: normal;
            margin: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .special-states {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .special-states-title {
            grid-column: 1 / -1;
            color: #3498db;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: 2px solid #ff6b6b;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(231, 76, 60, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
            color: white;
            border: 2px solid #2ecc71;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #219653 0%, #1e8449 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(39, 174, 96, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border: 2px solid #f1c40f;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(243, 156, 18, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border: 2px solid #7f8c8d;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(44, 62, 80, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: 2px solid #3498db;
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #2980b9 0%, #1c6ea4 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(52, 152, 219, 0.4);
        }
        
        .locations-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(231, 76, 60, 0.3);
            margin-top: 15px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #e74c3c;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .count-badge {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .locations-list {
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .location-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #3498db;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .location-item:hover {
            background: rgba(231, 76, 60, 0.1);
            transform: translateX(5px);
            border-left-color: #e74c3c;
        }
        
        .location-item.selected {
            background: rgba(52, 152, 219, 0.2);
            border-left-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
        }
        
        .location-item.duplicate {
            border-left-color: #f39c12;
        }
        
        .location-item.emergency {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            animation: pulse 2s infinite;
        }
        
        .location-item.puente {
            border-left-color: #9b59b6;
            background: rgba(155, 89, 182, 0.1);
        }
        
        .location-item.baterias {
            border-left-color: #f1c40f;
            background: rgba(241, 196, 15, 0.1);
        }
        
        .location-item.crossband {
            border-left-color: #1abc9c;
            background: rgba(26, 188, 156, 0.1);
        }
        
        .location-item.operator {
            border-left-color: #e67e22;
            background: rgba(230, 126, 34, 0.1);
            border: 1px solid #e67e22;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        .loc-name {
            font-weight: 600;
            font-size: 14px;
            color: #ecf0f1;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .indicativo-badge {
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .puente-badge, .baterias-badge, .crossband-badge, .emergency-station-badge, .poblacion-badge, .operator-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: bold;
            margin-left: 3px;
            white-space: nowrap;
        }
        
        .puente-badge { background: #9b59b6; color: white; }
        .baterias-badge { background: #f1c40f; color: #2c3e50; }
        .crossband-badge { background: #1abc9c; color: white; }
        .emergency-station-badge { background: #e74c3c; color: white; }
        .poblacion-badge { background: #2ecc71; color: white; }
        .operator-badge { background: #e67e22; color: white; }
        
        .loc-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            font-size: 10px;
            color: #bdc3c7;
            margin-top: 4px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .info-label {
            color: #95a5a6;
        }
        
        .info-value {
            font-weight: 600;
            color: #ecf0f1;
        }
        
        .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #e74c3c;
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .location-item:hover .delete-btn {
            opacity: 1;
        }
        
        .duplicate-badge {
            background: #f39c12;
            color: white;
            padding: 1px 4px;
            border-radius: 8px;
            font-size: 8px;
            font-weight: bold;
            margin-left: 6px;
        }
        
        .signal-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 3px;
        }
        
        .signal-excelente { background: #27ae60; }
        .signal-buena { background: #2ecc71; }
        .signal-regular { background: #f39c12; }
        .signal-mala { background: #e74c3c; }
        
        /* Modal para importar CSV */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            width: 90%;
            max-width: 700px;
            border-radius: 12px;
            padding: 25px;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid #e74c3c;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #e74c3c;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .file-upload-area {
            border: 3px dashed #e74c3c;
            border-radius: 8px;
            padding: 30px 15px;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            background: rgba(231, 76, 60, 0.1);
            border-color: #ff6b6b;
        }
        
        .file-upload-area i {
            font-size: 40px;
            color: #e74c3c;
            margin-bottom: 12px;
        }
        
        .csv-preview {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            max-height: 180px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            white-space: pre;
            color: white;
        }
        
        .csv-instructions {
            background: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 13px;
            color: #ecf0f1;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .csv-instructions h4 {
            color: #e74c3c;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .csv-example {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            color: white;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 22px;
            color: #e74c3c;
            cursor: pointer;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 15px;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .app-container {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                height: 500px;
            }
            
            .sidebar.collapsed {
                width: 0;
                height: 0;
            }
            
            .sidebar-toggle {
                display: none;
            }
            
            .main-content {
                height: 600px;
            }
            
            .filters-panel, .stats-panel {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .app-container {
                border-radius: 8px;
            }
            
            .sidebar {
                padding: 15px;
            }
            
            .header {
                padding: 12px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .coord-display {
                left: 10px;
                bottom: 10px;
                max-width: calc(100% - 20px);
                font-size: 11px;
                padding: 8px 12px;
            }
            
            .special-states {
                grid-template-columns: 1fr;
            }
            
            .loc-info {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .operator-coords-group {
                flex-direction: column;
            }
            
            .operator-coords-group input {
                width: 100%;
            }
            
            .operator-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Botón para ocultar/mostrar sidebar -->
        <button class="sidebar-toggle" id="sidebarToggle" title="Ocultar/Mostrar panel lateral">
            <i class="fas fa-chevron-left"></i>
        </button>
        
        <!-- Sidebar (izquierda) -->
        <div class="sidebar" id="sidebar">
            <!-- Formulario para agregar/editar estaciones -->
            <div class="form-section">
                <div class="form-title">
                    <i class="fas fa-broadcast-tower"></i>
                    <span id="form-title-text">Registrar Estación</span>
                </div>
                
                <input type="hidden" id="editing-id">
                
                <div class="form-group">
                    <label for="indicativo" class="required">Indicativo</label>
                    <input type="text" id="indicativo" placeholder="Ej: EA5XXX, EA7YYY">
                </div>
                
                <div class="form-group">
                    <label for="poblacion">Población <span class="optional">(opcional)</span></label>
                    <input type="text" id="poblacion" placeholder="Ej: Murcia, Cartagena, Lorca...">
                </div>
                
                <div class="form-group">
                    <label for="input-type" class="required">Tipo de Entrada</label>
                    <div class="input-selector">
                        <div class="input-option active" id="locator-option" onclick="setInputType('locator')">
                            <i class="fas fa-map-marker-alt"></i> Locator
                        </div>
                        <div class="input-option" id="coords-option" onclick="setInputType('coords')">
                            <i class="fas fa-globe-europe"></i> Coordenadas
                        </div>
                    </div>
                </div>
                
                <div class="form-group" id="locator-group">
                    <label for="locator-code" class="required">Locator</label>
                    <input type="text" id="locator-code" class="locator-input" 
                           placeholder="Ej: IM97SC, IM96RB" maxlength="10">
                    <small style="display: block; margin-top: 5px; color: #95a5a6;">
                        Formato: 2 letras + 2 números + 2 letras
                    </small>
                </div>
                
                <div class="form-group" id="coords-group" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label for="latitude" class="required">Latitud</label>
                            <input type="number" id="latitude" class="coordinate-input" 
                                   placeholder="37.9922" step="0.000001" min="-90" max="90">
                        </div>
                        <div>
                            <label for="longitude" class="required">Longitud</label>
                            <input type="number" id="longitude" class="coordinate-input" 
                                   placeholder="-1.1307" step="0.000001" min="-180" max="180">
                        </div>
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 5px;">
                        <button onclick="getCurrentLocation()" style="flex: 1; padding: 6px; background: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            <i class="fas fa-location-crosshairs"></i> Mi ubicación
                        </button>
                        <button onclick="convertCoordsToLocator()" style="flex: 1; padding: 6px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            <i class="fas fa-sync-alt"></i> Convertir
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="potencia">Potencia (W)</label>
                    <select id="potencia">
                        <option value="">Seleccionar potencia</option>
                        <option value="1">1W (QRP)</option>
                        <option value="5">5W</option>
                        <option value="10">10W</option>
                        <option value="25">25W</option>
                        <option value="50">50W</option>
                        <option value="100">100W</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="senal">Señal</label>
                    <select id="senal">
                        <option value="">Seleccionar calidad</option>
                        <option value="excelente">Excelente (59)</option>
                        <option value="buena">Buena (57-58)</option>
                        <option value="regular">Regular (55-56)</option>
                        <option value="mala">Mala (51-54)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="condiciones">Condiciones</label>
                    <select id="condiciones">
                        <option value="">Seleccionar tipo</option>
                        <option value="base">Base</option>
                        <option value="portatil">Portátil</option>
                        <option value="mobil">Móvil</option>
                        <option value="portable">Portable</option>
                    </select>
                </div>
                
                <div class="special-states">
                    <div class="special-states-title">
                        <i class="fas fa-star"></i> Estados Especiales
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="indicativo-puente">
                        <label for="indicativo-puente" class="checkbox-label">
                            <i class="fas fa-bridge"></i> Puente
                        </label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="estacion-baterias">
                        <label for="estacion-baterias" class="checkbox-label">
                            <i class="fas fa-battery-full"></i> Baterías
                        </label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="estacion-emergencia">
                        <label for="estacion-emergencia" class="checkbox-label">
                            <i class="fas fa-exclamation-triangle"></i> Emergencia
                        </label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="estacion-crossband">
                        <label for="estacion-crossband" class="checkbox-label">
                            <i class="fas fa-satellite-dish"></i> Crossband
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="description">Notas</label>
                    <textarea id="description" rows="2" placeholder="Equipo, antena..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-primary" id="add-edit-btn" onclick="addOrUpdateLocation()">
                        <i class="fas fa-satellite-dish"></i> Registrar
                    </button>
                    <button class="btn btn-info" id="update-btn" onclick="updateLocation()" style="display: none;">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
                
                <button class="btn btn-success" onclick="openImportModal()">
                    <i class="fas fa-file-import"></i> Importar CSV
                </button>
            </div>
            
            <!-- MODIFICADO: Panel de operador movido aquí, antes de la lista -->
            <div class="operator-section">
                <div class="operator-header" id="operatorHeader" onclick="toggleOperatorSection()">
                    <span><i class="fas fa-user-astronaut"></i> OPERADOR</span>
                    <i class="fas fa-chevron-up"></i>
                </div>
                
                <div class="operator-content" id="operatorContent">
                    <div class="operator-fields">
                        <div class="operator-field">
                            <label>Indicativo</label>
                            <input type="text" id="operador-callsign" placeholder="EA5XXX">
                        </div>
                        <div class="operator-field">
                            <label>Localidad</label>
                            <input type="text" id="operador-localidad" placeholder="Murcia">
                        </div>
                        <div class="operator-field">
                            <label>Frecuencia (MHz)</label>
                            <input type="text" id="operador-frecuencia" placeholder="145.325">
                        </div>
                    </div>
                    
                    <div class="operator-location-inputs">
                        <div class="operator-field">
                            <label>Locator</label>
                            <input type="text" id="operador-locator" class="locator-input" placeholder="IM97SC">
                        </div>
                        <div class="operator-coords-group">
                            <input type="number" id="operador-latitud" class="coordinate-input" placeholder="Latitud" step="0.000001">
                            <input type="number" id="operador-longitud" class="coordinate-input" placeholder="Longitud" step="0.000001">
                        </div>
                    </div>
                    
                    <div class="operator-actions">
                        <button class="btn-operator" onclick="convertOperatorCoordsToLocator()" title="Coordenadas → Locator">
                            <i class="fas fa-arrow-right"></i> Coord→Loc
                        </button>
                        <button class="btn-operator" onclick="convertOperatorLocatorToCoords()" title="Locator → Coordenadas">
                            <i class="fas fa-arrow-left"></i> Loc→Coord
                        </button>
                        <button class="btn-operator" onclick="registerOperator()" title="Registrar en mapa">
                            <i class="fas fa-map-pin"></i> Registrar
                        </button>
                    </div>
                    
                    <div class="operator-display" id="operator-display">
                        <span><i class="fas fa-user"></i> <span id="display-callsign">--</span></span>
                        <span><i class="fas fa-map-marker-alt"></i> <span id="display-localidad">--</span></span>
                        <span><i class="fas fa-radio"></i> <span id="display-frecuencia">--</span> MHz</span>
                        <span><i class="fas fa-satellite-dish"></i> <span id="display-locator">--</span></span>
                    </div>
                </div>
            </div>
            
            <!-- Lista de estaciones (ahora después del operador) -->
            <div class="locations-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-list"></i> Estaciones
                    </div>
                    <div class="count-badge" id="locations-count">0</div>
                </div>
                
                <div class="locations-list" id="locations-list"></div>
                
                <div style="margin-top: 15px;">
                    <button class="btn btn-info" onclick="exportToGPX()">
                        <i class="fas fa-map-marked-alt"></i> GPX
                    </button>
                    <button class="btn btn-warning" onclick="exportToCSV()" style="margin-top: 8px;">
                        <i class="fas fa-file-export"></i> CSV
                    </button>
                    <button class="btn btn-danger" onclick="clearAllLocations()" style="margin-top: 8px;">
                        <i class="fas fa-trash-alt"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mapa Principal -->
        <div class="main-content" id="mainContent">
            <div class="header">
                <h1>VOCALIA DE EMERGENCIAS REGIÓN DE MURCIA</h1>
                <h2>SISTEMA DE SEGUIMIENTO DE ESTACIONES</h2>
                <p>Red de comunicaciones de emergencia - Coordinación y monitorización</p>
                
                <div class="emergency-banner">
                    <i class="fas fa-exclamation-triangle"></i> 
                    RED DE EMERGENCIA ACTIVA - Frecuencia de Guardia: 145.325 MHz
                </div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
                
                <!-- MODIFICADO: Panel de filtros unificado (inicia oculto) -->
                <div class="filters-panel" id="filtersPanel">
                    <div class="filters-header" id="filtersHeader" onclick="toggleFilters()">
                        <span><i class="fas fa-filter"></i> FILTROS</span>
                        <i class="fas fa-chevron-up"></i>
                    </div>
                    
                    <div class="filters-content collapsed" id="filtersContent">
                        <div class="filter-group">
                            <div class="filter-title"><i class="fas fa-bolt"></i> Potencia</div>
                            <select id="filter-power" onchange="filterMarkers()" class="filter-select">
                                <option value="">Todas</option>
                                <option value="1">≤ 5W (QRP)</option>
                                <option value="10">10W</option>
                                <option value="25">25W</option>
                                <option value="50">50W</option>
                                <option value="100">100W</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <div class="filter-title"><i class="fas fa-signal"></i> Señal</div>
                            <select id="filter-signal" onchange="filterMarkers()" class="filter-select">
                                <option value="">Todas</option>
                                <option value="excelente">Excelente (59)</option>
                                <option value="buena">Buena (57-58)</option>
                                <option value="regular">Regular (55-56)</option>
                                <option value="mala">Mala (51-54)</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <div class="filter-title"><i class="fas fa-broadcast-tower"></i> Tipo</div>
                            <select id="filter-type" onchange="filterMarkers()" class="filter-select">
                                <option value="">Todos</option>
                                <option value="base">Base</option>
                                <option value="portatil">Portátil</option>
                                <option value="mobil">Móvil</option>
                                <option value="portable">Portable</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <div class="filter-title"><i class="fas fa-star"></i> Estados Especiales</div>
                            <div class="filter-options">
                                <div class="filter-option">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="filter-puente" onchange="filterMarkers()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span>Puentes</span>
                                </div>
                                <div class="filter-option">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="filter-baterias" onchange="filterMarkers()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span>Baterías</span>
                                </div>
                                <div class="filter-option">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="filter-crossband" onchange="filterMarkers()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span>Crossband</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- MODIFICADO: Panel de estadísticas (inicia oculto) -->
                <div class="stats-panel" id="statsPanel">
                    <div class="stats-header" id="statsHeader" onclick="toggleStats()">
                        <span><i class="fas fa-chart-bar"></i> ESTADÍSTICAS</span>
                        <i class="fas fa-chevron-up"></i>
                    </div>
                    
                    <div class="stats-content collapsed" id="statsContent">
                        <div class="stats-grid" id="stats-grid"></div>
                    </div>
                </div>
                
                <!-- Display de coordenadas -->
                <div class="coord-display" id="coord-display">
                    Mueve el cursor sobre el mapa...
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para importar CSV -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeImportModal()">&times;</button>
            
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-file-csv"></i> Importar Estaciones
                </div>
                <p>Sube un archivo CSV con las estaciones</p>
            </div>
            
            <div class="modal-body">
                <div class="file-upload-area" id="fileDropArea" onclick="document.getElementById('csvFileInput').click()">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>Arrastra y suelta tu archivo CSV</h3>
                    <p>o haz clic para seleccionar</p>
                </div>
                
                <input type="file" id="csvFileInput" accept=".csv,.txt" style="display: none;" onchange="handleFileSelect(event)">
                
                <div class="csv-instructions">
                    <h4>Formato CSV:</h4>
                    <p>Columnas: indicativo, poblacion, locator, potencia, senal, condiciones, puente, baterias, emergencia, crossband, description</p>
                    <p style="color: #e67e22; margin-top: 10px;">
                        <i class="fas fa-info-circle"></i> Datos del operador en nombre: OP_CALLSIGN_LOCALIDAD_FRECUENCIA_resto.csv
                    </p>
                </div>
                
                <div id="csvPreview" class="csv-preview" style="display: none;">
                    <pre id="previewContent"></pre>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-warning" onclick="closeImportModal()" style="width: auto;">Cancelar</button>
                <button class="btn btn-success" onclick="importFromCSV()" style="width: auto;" id="importBtn" disabled>
                    Importar
                </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // ========== CONFIGURACIÓN INICIAL ==========
        let map = L.map('map').setView([37.9922, -1.1307], 10);
        let markersLayer = L.layerGroup().addTo(map);
        let locations = [];
        let duplicateCodes = new Set();
        let csvData = null;
        let emergencyMode = false;
        let sidebarCollapsed = false;
        let editingLocationId = null;
        let inputType = 'locator';
        
        // Estado de paneles plegables
        let operatorSectionCollapsed = false;
        let filtersCollapsed = true;  // Inicia oculto
        let statsCollapsed = true;     // Inicia oculto
        
        // Variable para el operador
        let operadorMarker = null;
        let operadorActual = {
            callsign: '',
            localidad: '',
            frecuencia: '',
            lat: null,
            lon: null,
            locator: ''
        };
        
        // Capas base
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // ========== FUNCIONES DE INTERFAZ ==========
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebarToggle');
            const mainContent = document.getElementById('mainContent');
            
            sidebarCollapsed = !sidebarCollapsed;
            
            if (sidebarCollapsed) {
                sidebar.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                toggleBtn.title = "Mostrar panel lateral";
                mainContent.classList.add('expanded');
            } else {
                sidebar.classList.remove('collapsed');
                toggleBtn.classList.remove('collapsed');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                toggleBtn.title = "Ocultar panel lateral";
                mainContent.classList.remove('expanded');
            }
            
            setTimeout(() => {
                map.invalidateSize();
            }, 300);
        }
        
        function toggleOperatorSection() {
            const content = document.getElementById('operatorContent');
            const header = document.getElementById('operatorHeader');
            const chevron = header.querySelector('i:last-child');
            
            operatorSectionCollapsed = !operatorSectionCollapsed;
            
            if (operatorSectionCollapsed) {
                content.classList.add('collapsed');
                chevron.style.transform = 'rotate(-180deg)';
            } else {
                content.classList.remove('collapsed');
                chevron.style.transform = 'rotate(0deg)';
            }
        }
        
        function toggleFilters() {
            const content = document.getElementById('filtersContent');
            const header = document.getElementById('filtersHeader');
            const chevron = header.querySelector('i:last-child');
            
            filtersCollapsed = !filtersCollapsed;
            
            if (filtersCollapsed) {
                content.classList.add('collapsed');
                chevron.style.transform = 'rotate(-180deg)';
            } else {
                content.classList.remove('collapsed');
                chevron.style.transform = 'rotate(0deg)';
            }
        }
        
        function toggleStats() {
            const content = document.getElementById('statsContent');
            const header = document.getElementById('statsHeader');
            const chevron = header.querySelector('i:last-child');
            
            statsCollapsed = !statsCollapsed;
            
            if (statsCollapsed) {
                content.classList.add('collapsed');
                chevron.style.transform = 'rotate(-180deg)';
            } else {
                content.classList.remove('collapsed');
                chevron.style.transform = 'rotate(0deg)';
            }
        }
        
        // ========== FUNCIONES DEL OPERADOR ==========
        function convertOperatorCoordsToLocator() {
            const lat = parseFloat(document.getElementById('operador-latitud').value);
            const lon = parseFloat(document.getElementById('operador-longitud').value);
            
            if (isNaN(lat) || isNaN(lon)) {
                alert('Introduce coordenadas válidas');
                return;
            }
            
            const locator = latLonToMaidenhead(lat, lon, 6);
            document.getElementById('operador-locator').value = locator;
        }
        
        function convertOperatorLocatorToCoords() {
            const locator = document.getElementById('operador-locator').value.trim().toUpperCase();
            
            if (!locator) {
                alert('Introduce un Locator válido');
                return;
            }
            
            try {
                const coords = maidenheadToLatLon(locator);
                document.getElementById('operador-latitud').value = coords.lat.toFixed(6);
                document.getElementById('operador-longitud').value = coords.lon.toFixed(6);
            } catch (e) {
                alert('Locator inválido: ' + e.message);
            }
        }
        
        function updateOperatorDisplay() {
            document.getElementById('display-callsign').textContent = operadorActual.callsign || '--';
            document.getElementById('display-localidad').textContent = operadorActual.localidad || '--';
            document.getElementById('display-frecuencia').textContent = operadorActual.frecuencia || '--';
            document.getElementById('display-locator').textContent = operadorActual.locator || '--';
        }
        
        function registerOperator() {
            const callsign = document.getElementById('operador-callsign').value.trim().toUpperCase();
            const localidad = document.getElementById('operador-localidad').value.trim();
            const frecuencia = document.getElementById('operador-frecuencia').value.trim();
            const locator = document.getElementById('operador-locator').value.trim().toUpperCase();
            const lat = parseFloat(document.getElementById('operador-latitud').value);
            const lon = parseFloat(document.getElementById('operador-longitud').value);
            
            if (!callsign) {
                alert('El indicativo del operador es obligatorio');
                return;
            }
            
            let finalLat, finalLon, finalLocator;
            
            if (locator && !isNaN(lat) && !isNaN(lon)) {
                finalLat = lat;
                finalLon = lon;
                finalLocator = locator;
            } else if (locator) {
                try {
                    const coords = maidenheadToLatLon(locator);
                    finalLat = coords.lat;
                    finalLon = coords.lon;
                    finalLocator = locator;
                    document.getElementById('operador-latitud').value = finalLat.toFixed(6);
                    document.getElementById('operador-longitud').value = finalLon.toFixed(6);
                } catch (e) {
                    alert('Locator inválido: ' + e.message);
                    return;
                }
            } else if (!isNaN(lat) && !isNaN(lon)) {
                finalLat = lat;
                finalLon = lon;
                finalLocator = latLonToMaidenhead(lat, lon, 6);
                document.getElementById('operador-locator').value = finalLocator;
            } else {
                alert('Debes proporcionar un Locator o coordenadas');
                return;
            }
            
            operadorActual = {
                callsign: callsign,
                localidad: localidad,
                frecuencia: frecuencia,
                lat: finalLat,
                lon: finalLon,
                locator: finalLocator
            };
            
            updateOperatorDisplay();
            
            if (operadorMarker) {
                map.removeLayer(operadorMarker);
            }
            
            const operatorIcon = L.divIcon({
                html: `
                    <div style="
                        background: rgba(230, 126, 34, 0.9);
                        border-radius: 50%;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        width: 50px;
                        height: 50px;
                        padding: 3px;
                        border: 3px solid #f39c12;
                        box-shadow: 0 2px 15px rgba(230, 126, 34, 0.6);
                    ">
                        <div style="font-size: 16px;">👤</div>
                        <div style="
                            color: white;
                            font-weight: bold;
                            font-size: 8px;
                            text-align: center;
                        ">${callsign}</div>
                    </div>
                `,
                className: 'operator-marker',
                iconSize: [50, 50],
                iconAnchor: [25, 50]
            });
            
            operadorMarker = L.marker([finalLat, finalLon], { icon: operatorIcon }).addTo(map);
            
            const popupContent = `
                <div style="min-width: 200px;">
                    <div style="background: #e67e22; color: white; padding: 8px;">
                        <h3 style="margin: 0; font-size: 14px;">OPERADOR</h3>
                    </div>
                    <div style="padding: 8px;">
                        <div><strong>Indicativo:</strong> ${callsign}</div>
                        ${localidad ? `<div><strong>Localidad:</strong> ${localidad}</div>` : ''}
                        ${frecuencia ? `<div><strong>Frecuencia:</strong> ${frecuencia} MHz</div>` : ''}
                        <div><strong>Locator:</strong> ${finalLocator}</div>
                    </div>
                </div>
            `;
            
            operadorMarker.bindPopup(popupContent);
            operadorMarker.openPopup();
            map.setView([finalLat, finalLon], 12);
        }
        
        // ========== RESTO DE FUNCIONES (sin cambios) ==========
        function setInputType(type) {
            inputType = type;
            document.getElementById('locator-option').classList.toggle('active', type === 'locator');
            document.getElementById('coords-option').classList.toggle('active', type === 'coords');
            document.getElementById('locator-group').style.display = type === 'locator' ? 'block' : 'none';
            document.getElementById('coords-group').style.display = type === 'coords' ? 'block' : 'none';
        }
        
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    document.getElementById('latitude').value = position.coords.latitude.toFixed(6);
                    document.getElementById('longitude').value = position.coords.longitude.toFixed(6);
                });
            }
        }
        
        function convertCoordsToLocator() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            if (!isNaN(lat) && !isNaN(lon)) {
                alert('Locator: ' + latLonToMaidenhead(lat, lon, 6));
            }
        }
        
        function maidenheadToLatLon(maidenhead) {
            maidenhead = maidenhead.toUpperCase().trim();
            if (!/^[A-R]{2}\d{2}([A-X]{2}(\d{2})?)?$/i.test(maidenhead)) {
                throw new Error('Formato Locator inválido');
            }
            
            let field = maidenhead.substring(0, 2);
            let square = maidenhead.substring(2, 4);
            let subsquare = maidenhead.substring(4, 6) || '';
            
            function charToNumber(char) {
                return char.charCodeAt(0) - 'A'.charCodeAt(0);
            }
            
            let lonField = charToNumber(field[0]) * 20 - 180;
            let latField = charToNumber(field[1]) * 10 - 90;
            let lonSquare = parseInt(square[0]) * 2;
            let latSquare = parseInt(square[1]) * 1;
            let lonSub = subsquare ? charToNumber(subsquare[0]) * (5/60) : 0;
            let latSub = subsquare ? charToNumber(subsquare[1]) * (2.5/60) : 0;
            
            let lon = lonField + lonSquare + lonSub + (5/60)/2;
            let lat = latField + latSquare + latSub + (2.5/60)/2;
            
            return { lat, lon };
        }
        
        function generateOffsetWithinGrid(precision, index) {
            const maxOffset = { 4: 0.5, 6: 0.04, 8: 0.002 }[precision] || 0.02;
            const angle = (index * 137.5) % 360;
            const distance = maxOffset * 0.7;
            return {
                latOffset: Math.sin(angle * Math.PI / 180) * distance,
                lonOffset: Math.cos(angle * Math.PI / 180) * distance
            };
        }
        
        function latLonToMaidenhead(lat, lon, precision = 6) {
            lon += 180;
            lat += 90;
            let code = '';
            
            code += String.fromCharCode('A'.charCodeAt(0) + Math.floor(lon / 20));
            code += String.fromCharCode('A'.charCodeAt(0) + Math.floor(lat / 10));
            
            if (precision >= 4) {
                code += Math.floor((lon % 20) / 2).toString();
                code += Math.floor((lat % 10) / 1).toString();
            }
            
            if (precision >= 6) {
                code += String.fromCharCode('a'.charCodeAt(0) + Math.floor(((lon % 20) % 2) * 60 / 5));
                code += String.fromCharCode('a'.charCodeAt(0) + Math.floor(((lat % 10) % 1) * 60 / 2.5));
            }
            
            return code.toUpperCase();
        }
        
        function fillFormForEditing(location) {
            document.getElementById('form-title-text').textContent = 'Editar Estación';
            document.getElementById('editing-id').value = location.id;
            document.getElementById('indicativo').value = location.indicativo;
            document.getElementById('poblacion').value = location.poblacion || '';
            
            if (location.coordsEntered) {
                setInputType('coords');
                document.getElementById('latitude').value = location.lat.toFixed(6);
                document.getElementById('longitude').value = location.lon.toFixed(6);
            } else {
                setInputType('locator');
                document.getElementById('locator-code').value = location.code;
            }
            
            document.getElementById('potencia').value = location.potencia;
            document.getElementById('senal').value = location.senal;
            document.getElementById('condiciones').value = location.condiciones;
            document.getElementById('indicativo-puente').checked = location.puente || false;
            document.getElementById('estacion-baterias').checked = location.baterias || false;
            document.getElementById('estacion-emergencia').checked = location.emergencia || false;
            document.getElementById('estacion-crossband').checked = location.crossband || false;
            document.getElementById('description').value = location.description || '';
            
            document.getElementById('add-edit-btn').style.display = 'none';
            document.getElementById('update-btn').style.display = 'flex';
        }
        
        function clearForm() {
            document.getElementById('form-title-text').textContent = 'Registrar Estación';
            document.getElementById('editing-id').value = '';
            document.getElementById('indicativo').value = '';
            document.getElementById('poblacion').value = '';
            setInputType('locator');
            document.getElementById('locator-code').value = '';
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            document.getElementById('potencia').value = '';
            document.getElementById('senal').value = '';
            document.getElementById('condiciones').value = '';
            document.getElementById('indicativo-puente').checked = false;
            document.getElementById('estacion-baterias').checked = false;
            document.getElementById('estacion-emergencia').checked = false;
            document.getElementById('estacion-crossband').checked = false;
            document.getElementById('description').value = '';
            document.getElementById('add-edit-btn').style.display = 'flex';
            document.getElementById('update-btn').style.display = 'none';
        }
        
        function getCurrentDateTime() {
            return new Date().toISOString();
        }
        
        function getFormattedDateTime(dateTime) {
            return new Date(dateTime).toLocaleString('es-ES');
        }
        
        function addOrUpdateLocation() {
            const indicativo = document.getElementById('indicativo').value.trim().toUpperCase();
            const poblacion = document.getElementById('poblacion').value.trim();
            let code, lat, lon, coordsEntered = false;
            
            if (inputType === 'locator') {
                code = document.getElementById('locator-code').value.trim().toUpperCase();
                if (!code) { alert('Ingresa el Locator'); return; }
            } else {
                lat = parseFloat(document.getElementById('latitude').value);
                lon = parseFloat(document.getElementById('longitude').value);
                if (isNaN(lat) || isNaN(lon)) { alert('Coordenadas válidas'); return; }
                code = latLonToMaidenhead(lat, lon, 6);
                coordsEntered = true;
            }
            
            const potencia = document.getElementById('potencia').value;
            const senal = document.getElementById('senal').value;
            const condiciones = document.getElementById('condiciones').value;
            const puente = document.getElementById('indicativo-puente').checked;
            const baterias = document.getElementById('estacion-baterias').checked;
            const emergencia = document.getElementById('estacion-emergencia').checked;
            const crossband = document.getElementById('estacion-crossband').checked;
            const description = document.getElementById('description').value.trim();
            
            if (!indicativo) { alert('Indicativo obligatorio'); return; }
            
            try {
                let finalLat, finalLon, baseLat, baseLon;
                
                if (coordsEntered) {
                    finalLat = baseLat = lat;
                    finalLon = baseLon = lon;
                } else {
                    const baseCoords = maidenheadToLatLon(code);
                    baseLat = baseCoords.lat;
                    baseLon = baseCoords.lon;
                    finalLat = baseLat;
                    finalLon = baseLon;
                    
                    const duplicateIndex = locations.filter(l => l.code === code).length;
                    if (duplicateIndex > 0) {
                        const offset = generateOffsetWithinGrid(code.length, duplicateIndex);
                        finalLat += offset.latOffset;
                        finalLon += offset.lonOffset;
                        duplicateCodes.add(code);
                    }
                }
                
                const icon = L.divIcon({
                    html: `<div style="background:rgba(0,0,0,0.7); border-radius:50%; width:50px; height:50px; display:flex; align-items:center; justify-content:center; border:2px solid ${puente?'#9b59b6':baterias?'#f1c40f':crossband?'#1abc9c':emergencia?'#e74c3c':'#3498db'};"><span style="color:white; font-weight:bold; font-size:11px;">${indicativo}</span></div>`,
                    iconSize: [50, 50],
                    iconAnchor: [25, 50]
                });
                
                const marker = L.marker([finalLat, finalLon], { icon }).addTo(markersLayer);
                
                marker.on('click', () => {
                    const loc = locations.find(l => l.marker === marker);
                    if (loc) fillFormForEditing(loc);
                });
                
                const location = {
                    id: Date.now() + Math.random(),
                    indicativo, poblacion, code, potencia, senal, condiciones,
                    ultimoQtc: getCurrentDateTime(),
                    ultimoQtcFormatted: getFormattedDateTime(getCurrentDateTime()),
                    puente, baterias, emergencia, crossband, description,
                    lat: finalLat, lon: finalLon, baseLat, baseLon,
                    coordsEntered, marker,
                    addedAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                locations.push(location);
                updateLocationsList();
                updateStats();
                marker.openPopup();
                clearForm();
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function updateLocation() {
            const id = document.getElementById('editing-id').value;
            if (!id) return;
            
            const index = locations.findIndex(l => l.id == id);
            if (index === -1) return;
            
            const indicativo = document.getElementById('indicativo').value.trim().toUpperCase();
            const poblacion = document.getElementById('poblacion').value.trim();
            
            locations[index].indicativo = indicativo;
            locations[index].poblacion = poblacion;
            locations[index].potencia = document.getElementById('potencia').value;
            locations[index].senal = document.getElementById('senal').value;
            locations[index].condiciones = document.getElementById('condiciones').value;
            locations[index].puente = document.getElementById('indicativo-puente').checked;
            locations[index].baterias = document.getElementById('estacion-baterias').checked;
            locations[index].emergencia = document.getElementById('estacion-emergencia').checked;
            locations[index].crossband = document.getElementById('estacion-crossband').checked;
            locations[index].description = document.getElementById('description').value.trim();
            locations[index].updatedAt = new Date().toISOString();
            
            updateLocationsList();
            updateStats();
            clearForm();
        }
        
        function updateLocationsList() {
            const container = document.getElementById('locations-list');
            document.getElementById('locations-count').textContent = locations.length;
            
            if (locations.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#95a5a6;">No hay estaciones</div>';
                return;
            }
            
            container.innerHTML = '';
            locations.sort((a, b) => a.indicativo.localeCompare(b.indicativo));
            
            locations.forEach(loc => {
                const item = document.createElement('div');
                item.className = 'location-item';
                item.dataset.id = loc.id;
                
                let badges = '';
                if (loc.poblacion) badges += `<span class="poblacion-badge"><i class="fas fa-map-pin"></i> ${loc.poblacion}</span>`;
                if (loc.puente) badges += '<span class="puente-badge"><i class="fas fa-bridge"></i> PUENTE</span>';
                if (loc.baterias) badges += '<span class="baterias-badge"><i class="fas fa-battery-full"></i> BATERÍAS</span>';
                if (loc.crossband) badges += '<span class="crossband-badge"><i class="fas fa-satellite-dish"></i> CROSSBAND</span>';
                if (loc.emergencia) badges += '<span class="emergency-station-badge"><i class="fas fa-exclamation-triangle"></i> EMERGENCIA</span>';
                
                item.innerHTML = `
                    <div class="loc-name">
                        <span>${loc.indicativo} ${badges}</span>
                        <span class="indicativo-badge">${loc.code}</span>
                    </div>
                    <div class="loc-info">
                        <div class="info-item"><span class="info-label">Pot:</span> <span class="info-value">${loc.potencia || '--'}W</span></div>
                        <div class="info-item"><span class="info-label">Señal:</span> <span class="info-value">${loc.senal || '--'}</span></div>
                        <div class="info-item"><span class="info-label">Tipo:</span> <span class="info-value">${loc.condiciones || '--'}</span></div>
                    </div>
                    <button class="delete-btn" onclick="removeLocation('${loc.id}', event)"><i class="fas fa-times"></i></button>
                `;
                
                item.onclick = (e) => {
                    if (!e.target.classList.contains('delete-btn')) {
                        map.setView([loc.lat, loc.lon], 12);
                        loc.marker.openPopup();
                        fillFormForEditing(loc);
                    }
                };
                
                container.appendChild(item);
            });
        }
        
        function removeLocation(id, event) {
            event.stopPropagation();
            if (!confirm('¿Eliminar esta estación?')) return;
            
            const index = locations.findIndex(l => l.id == id);
            if (index !== -1) {
                map.removeLayer(locations[index].marker);
                locations.splice(index, 1);
                updateLocationsList();
                updateStats();
            }
        }
        
        function clearAllLocations() {
            if (locations.length === 0) return;
            if (confirm(`¿Eliminar todas las ${locations.length} estaciones?`)) {
                markersLayer.clearLayers();
                locations = [];
                duplicateCodes.clear();
                updateLocationsList();
                updateStats();
                clearForm();
            }
        }
        
        function filterMarkers() {
            const power = document.getElementById('filter-power').value;
            const signal = document.getElementById('filter-signal').value;
            const type = document.getElementById('filter-type').value;
            const puente = document.getElementById('filter-puente').checked;
            const baterias = document.getElementById('filter-baterias').checked;
            const crossband = document.getElementById('filter-crossband').checked;
            
            locations.forEach(loc => loc.marker.addTo(markersLayer));
            
            if (power || signal || type || puente || baterias || crossband) {
                locations.forEach(loc => {
                    let show = true;
                    if (power === '1' && parseInt(loc.potencia) > 5) show = false;
                    if (power === '10' && parseInt(loc.potencia) !== 10) show = false;
                    if (power === '25' && parseInt(loc.potencia) !== 25) show = false;
                    if (power === '50' && parseInt(loc.potencia) !== 50) show = false;
                    if (power === '100' && parseInt(loc.potencia) !== 100) show = false;
                    if (signal && loc.senal !== signal) show = false;
                    if (type && loc.condiciones !== type) show = false;
                    if (puente && !loc.puente) show = false;
                    if (baterias && !loc.baterias) show = false;
                    if (crossband && !loc.crossband) show = false;
                    if (!show) map.removeLayer(loc.marker);
                });
            }
            
            if (operadorMarker) operadorMarker.addTo(map);
        }
        
        function updateStats() {
            const total = locations.length;
            const puente = locations.filter(l => l.puente).length;
            const baterias = locations.filter(l => l.baterias).length;
            const crossband = locations.filter(l => l.crossband).length;
            const emergencia = locations.filter(l => l.emergencia).length;
            
            document.getElementById('stats-grid').innerHTML = `
                <div class="stat-item"><span class="stat-label">Total:</span> <span class="stat-value">${total}</span></div>
                <div class="stat-item"><span class="stat-label">Puentes:</span> <span class="stat-value puente">${puente}</span></div>
                <div class="stat-item"><span class="stat-label">Baterías:</span> <span class="stat-value baterias">${baterias}</span></div>
                <div class="stat-item"><span class="stat-label">Crossband:</span> <span class="stat-value crossband">${crossband}</span></div>
                <div class="stat-item"><span class="stat-label">Emergencia:</span> <span class="stat-value">${emergencia}</span></div>
            `;
        }
        
        function centerOnMurcia() {
            map.setView([37.9922, -1.1307], 10);
        }
        
        function fitAllMarkers() {
            if (locations.length === 0 && !operadorMarker) return;
            const points = locations.map(l => [l.lat, l.lon]);
            if (operadorMarker) points.push([operadorActual.lat, operadorActual.lon]);
            map.fitBounds(L.latLngBounds(points), {padding: [50, 50]});
        }
        
        function toggleEmergencyMode() {
            emergencyMode = !emergencyMode;
            const btn = document.getElementById('emergencyBtn');
            
            if (emergencyMode) {
                locations.forEach(l => {
                    const good = l.senal === 'excelente' || l.senal === 'buena';
                    const high = parseInt(l.potencia) >= 50;
                    if (!((good && high) || l.emergencia)) map.removeLayer(l.marker);
                });
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Normal';
                btn.style.background = '#e74c3c';
                document.body.classList.add('emergency-mode');
            } else {
                locations.forEach(l => l.marker.addTo(markersLayer));
                btn.innerHTML = '<i class="fas fa-exclamation"></i> Emergencia';
                btn.style.background = '#f39c12';
                document.body.classList.remove('emergency-mode');
            }
            if (operadorMarker) operadorMarker.addTo(map);
        }
        
        function exportToGPX() {
            if (locations.length === 0) return alert('No hay estaciones');
            
            let gpx = `<?xml version="1.0"?>
<gpx version="1.1" creator="Vocalia Emergencias Murcia">
    <metadata><name>Estaciones Emergencia Murcia</name><time>${new Date().toISOString()}</time></metadata>`;
            
            if (operadorMarker) {
                gpx += `
    <wpt lat="${operadorActual.lat}" lon="${operadorActual.lon}">
        <name>👤 ${operadorActual.callsign} (OPERADOR)</name>
        <desc>${operadorActual.callsign} | ${operadorActual.localidad} | ${operadorActual.frecuencia} MHz</desc>
        <sym>User</sym>
    </wpt>`;
            }
            
            locations.forEach(l => {
                gpx += `
    <wpt lat="${l.lat}" lon="${l.lon}">
        <name>${l.indicativo}${l.poblacion ? ' - ' + l.poblacion : ''}</name>
        <desc>Loc: ${l.code} | Pot: ${l.potencia}W | Señal: ${l.senal}</desc>
        <sym>Flag, Blue</sym>
    </wpt>`;
            });
            
            gpx += '\n</gpx>';
            
            let filename = `estaciones_${new Date().toISOString().slice(0,10)}`;
            if (operadorActual.callsign) {
                filename = `OP_${operadorActual.callsign}_${operadorActual.localidad || 'NOLOC'}_${operadorActual.frecuencia || 'NOFREQ'}_${filename}`;
            }
            
            const blob = new Blob([gpx], {type: 'application/gpx+xml'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename + '.gpx';
            link.click();
        }
        
        function exportToCSV() {
            if (locations.length === 0) return alert('No hay estaciones');
            
            const headers = ['Indicativo', 'Población', 'Locator', 'Latitud', 'Longitud', 'Potencia', 'Señal', 'Condiciones', 'Puente', 'Baterías', 'Emergencia', 'Crossband', 'Descripción'];
            const rows = locations.map(l => [
                `"${l.indicativo}"`, `"${l.poblacion || ''}"`, `"${l.code}"`, l.lat, l.lon,
                l.potencia || '', l.senal || '', l.condiciones || '',
                l.puente ? 'Sí' : 'No', l.baterias ? 'Sí' : 'No',
                l.emergencia ? 'Sí' : 'No', l.crossband ? 'Sí' : 'No',
                `"${l.description || ''}"`
            ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            
            let filename = `estaciones_${new Date().toISOString().slice(0,10)}`;
            if (operadorActual.callsign) {
                filename = `OP_${operadorActual.callsign}_${operadorActual.localidad || 'NOLOC'}_${operadorActual.frecuencia || 'NOFREQ'}_${filename}`;
            }
            
            const blob = new Blob(["\uFEFF" + csv], {type: 'text/csv'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename + '.csv';
            link.click();
        }
        
        function openImportModal() {
            document.getElementById('importModal').style.display = 'flex';
            document.getElementById('importBtn').disabled = true;
            csvData = null;
        }
        
        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
        }
        
        function parseOperatorFromFilename(filename) {
            const match = filename.match(/^OP_([^_]+)_([^_]+)_([^_]+)_/);
            return match ? { callsign: match[1], localidad: match[2], frecuencia: match[3] } : null;
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const opData = parseOperatorFromFilename(file.name);
            if (opData) {
                document.getElementById('operador-callsign').value = opData.callsign;
                document.getElementById('operador-localidad').value = opData.localidad;
                document.getElementById('operador-frecuencia').value = opData.frecuencia;
            }
            
            const reader = new FileReader();
            reader.onload = e => {
                csvData = parseCSV(e.target.result);
                document.getElementById('importBtn').disabled = !csvData;
                if (csvData) {
                    document.getElementById('previewContent').textContent = e.target.result.substring(0, 500);
                    document.getElementById('csvPreview').style.display = 'block';
                }
            };
            reader.readAsText(file);
        }
        
        function parseCSV(text) {
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length < 2) return null;
            
            const headers = lines[0].toLowerCase().split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                if (values.length < 2) continue;
                
                const item = {
                    indicativo: values[headers.indexOf('indicativo')] || '',
                    poblacion: values[headers.indexOf('poblacion')] || '',
                    locator: (values[headers.indexOf('locator')] || '').toUpperCase(),
                    potencia: values[headers.indexOf('potencia')] || '',
                    senal: values[headers.indexOf('senal')] || '',
                    condiciones: values[headers.indexOf('condiciones')] || '',
                    puente: values[headers.indexOf('puente')] === 'true' || values[headers.indexOf('puente')] === '1' || values[headers.indexOf('puente')] === 'sí',
                    baterias: values[headers.indexOf('baterias')] === 'true' || values[headers.indexOf('baterias')] === '1',
                    emergencia: values[headers.indexOf('emergencia')] === 'true' || values[headers.indexOf('emergencia')] === '1',
                    crossband: values[headers.indexOf('crossband')] === 'true' || values[headers.indexOf('crossband')] === '1',
                    description: values[headers.indexOf('description')] || values[headers.indexOf('descripción')] || ''
                };
                
                if (item.indicativo && item.locator) data.push(item);
            }
            
            return data.length ? data : null;
        }
        
        function importFromCSV() {
            if (!csvData) return;
            
            let count = 0;
            csvData.forEach(item => {
                try {
                    const coords = maidenheadToLatLon(item.locator);
                    const icon = L.divIcon({ html: `<div style="background:rgba(0,0,0,0.7); border-radius:50%; width:50px; height:50px; display:flex; align-items:center; justify-content:center;"><span style="color:white; font-size:11px;">${item.indicativo}</span></div>`, iconSize: [50, 50], iconAnchor: [25, 50] });
                    
                    const marker = L.marker([coords.lat, coords.lon], { icon }).addTo(markersLayer);
                    
                    locations.push({
                        id: Date.now() + Math.random(),
                        indicativo: item.indicativo,
                        poblacion: item.poblacion,
                        code: item.locator,
                        potencia: item.potencia,
                        senal: item.senal,
                        condiciones: item.condiciones,
                        ultimoQtc: getCurrentDateTime(),
                        ultimoQtcFormatted: getFormattedDateTime(getCurrentDateTime()),
                        puente: item.puente,
                        baterias: item.baterias,
                        emergencia: item.emergencia,
                        crossband: item.crossband,
                        description: item.description,
                        lat: coords.lat,
                        lon: coords.lon,
                        baseLat: coords.lat,
                        baseLon: coords.lon,
                        coordsEntered: false,
                        marker: marker,
                        addedAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                    count++;
                } catch (e) {
                    console.warn('Error importando:', item.indicativo, e);
                }
            });
            
            updateLocationsList();
            updateStats();
            alert(`Importadas ${count} estaciones`);
            closeImportModal();
        }
        
        // ========== INICIALIZACIÓN ==========
        document.addEventListener('DOMContentLoaded', function() {
            updateLocationsList();
            updateStats();
            
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
            
            // Inicializar paneles plegados
            document.getElementById('filtersContent').classList.add('collapsed');
            document.getElementById('statsContent').classList.add('collapsed');
            
            map.on('mousemove', function(e) {
                document.getElementById('coord-display').innerHTML = 
                    `Lat: ${e.latlng.lat.toFixed(6)}° Lon: ${e.latlng.lng.toFixed(6)}°<br>Loc: ${latLonToMaidenhead(e.latlng.lat, e.latlng.lng, 6)}`;
            });
            
            setTimeout(centerOnMurcia, 500);
            
            console.log('✅ VOCALIA DE EMERGENCIAS REGIÓN DE MURCIA');
            console.log('📡 Frecuencia de guardia: 145.325 MHz');
            console.log('👤 Panel operador en sidebar');
            console.log('🎛️ Filtros agrupados a la derecha (inician ocultos)');
        });
    </script>
</body>
</html>
